<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>THDX ‚Ä¢ Sepolia ‚Üí Monad Bridge (Wormhole)</title>
<meta name="theme-color" content="#0b1220" />
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<style>
  :root{
    --bg:#0b1220;--card:#121a2a;--muted:#9aa6b2;--stroke:#22304a;--text:#e6edf3;
    --pri1:#6ee7ff;--pri2:#7c5cff;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
  }
  *{box-sizing:border-box} body{
    margin:0;min-height:100svh;display:grid;place-items:center;background:var(--bg);
    color:var(--text);font-family:Inter,system-ui,Arial,sans-serif
  }
  .wrap{width:min(560px,92vw)}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:22px;box-shadow:0 6px 20px rgba(0,0,0,.35)}
  h1{margin:0 0 6px;font-size:22px}
  p.sub{margin:0 0 16px;color:var(--muted)}
  label{display:block;margin:12px 0 6px;color:#cfe3ff;font-weight:600;font-size:13px}
  select,input{width:100%;padding:12px 13px;border-radius:10px;border:1px solid var(--stroke);background:#0f1625;color:#fff;font-size:14px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button{
    width:100%;padding:12px;border:0;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;
    background:linear-gradient(90deg,var(--pri1),var(--pri2));transition:.2s;margin-top:12px
  }
  button.secondary{background:#1b263b}
  button.ok{background:linear-gradient(90deg,#16a34a,#22c55e)}
  button:disabled{opacity:.55;cursor:not-allowed}
  pre{
    margin-top:14px;white-space:pre-wrap;background:#0f1625;border:1px solid var(--stroke);
    border-radius:10px;padding:12px;min-height:120px;font-size:12.5px
  }
  .hint{color:var(--muted);font-size:12px;margin-top:6px}
</style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>THDX ‚Ä¢ Wormhole Bridge</h1>
      <p class="sub">Mode: <b>Sepolia ‚Üí Monad (testnet)</b></p>

      <div class="row">
        <button id="btnConnect">üîå Connect Wallet</button>
        <button id="btnApprove" class="secondary" disabled>‚úÖ Approve</button>
      </div>

      <label>Token</label>
      <select id="tokenSel">
        <option value="USDC">USDC (6 desimal)</option>
        <option value="USDT">USDT (6 desimal)</option>
        <option value="WBTC">WBTC (8 desimal)</option>
      </select>

      <label>Jumlah (angka manusia, contoh: 10)</label>
      <input id="amount" type="number" placeholder="Contoh: 10" inputmode="decimal"/>

      <label>Recipient (EVM) ‚Ä¢ default: alamat sendiri</label>
      <input id="recipient" type="text" placeholder="0x..." />

      <button id="btnBridge" class="ok" disabled>üöÄ Bridge ke Monad</button>
      <div class="hint">
        Wormhole TokenBridge (Sepolia): <code>0x6c5aAE4622B835058A41879bA5e128019B9047d6</code><br/>
        DstChain (Monad testnet) Wormhole ChainID: <code>31041</code>
      </div>

      <pre id="log">log siap...</pre>
    </div>
  </div>

<script>
(() => {
  // ====== KONSTAN ======
  const CHAIN_SEPOLIA = 11155111;
  const WORMHOLE_BRIDGE = "0x6c5aAE4622B835058A41879bA5e128019B9047d6"; // TokenBridge (Sepolia)
  const DST_CHAIN_ID = 31041; // Monad testnet (Wormhole chainId)

  // Token Sepolia (alamat & desimal)
  const TOKENS = {
    USDC: { addr: "0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238", decimals: 6 },
    USDT: { addr: "0xaA8E23Fb1079EA71e0a56F48a2aA51851D8433D0", decimals: 6 },
    WBTC: { addr: "0x52eeA312378ef46140EBE67dE8a143BA2304FD7C", decimals: 8 },
  };

  // ====== STATE ======
  let provider, signer, me;

  // ====== UI ======
  const $ = (q)=>document.querySelector(q);
  const log = (m)=>{ const el=$("#log"); el.textContent += (el.textContent?"\n":"")+m; el.scrollTop=el.scrollHeight; console.log(m); };

  const toBytes32Address = (addr) => {
    const clean = addr.toLowerCase().replace(/^0x/,"");
    return "0x"+"0".repeat(64-40)+clean;
  };

  const parseAmount = (raw, decimals) => {
    if (!raw || Number(raw)<=0) throw new Error("Isi jumlah > 0");
    return ethers.utils.parseUnits(String(raw), decimals);
  };

  const ensureSepolia = async () => {
    const net = await provider.getNetwork();
    if (net.chainId === CHAIN_SEPOLIA) return;
    log(`‚ö†Ô∏è Bukan di Sepolia (chainId sekarang: ${net.chainId}). Coba switch...`);
    try {
      await provider.send("wallet_switchEthereumChain", [{ chainId: "0xaa36a7" }]); // 11155111 hex
      log("‚úÖ Berhasil switch ke Sepolia.");
    } catch (e) {
      log("‚ùå Gagal switch chain. Tambahkan Sepolia di wallet lalu ulangi.");
      throw e;
    }
  };

  // ====== CONNECT ======
  $("#btnConnect").onclick = async () => {
    try {
      if (!window.ethereum) throw new Error("Buka di MetaMask/OKX/Trust browser.");
      provider = new ethers.providers.Web3Provider(window.ethereum, "any");
      await provider.send("eth_requestAccounts", []);
      signer = provider.getSigner();
      me = await signer.getAddress();
      await ensureSepolia();
      $("#recipient").value = me;
      $("#btnApprove").disabled = false;
      $("#btnBridge").disabled = false;
      log(`‚úÖ Connected: ${me}\nChain: ${(await provider.getNetwork()).chainId}`);
    } catch (e) {
      log("‚ùå Connect error: " + (e.message || e));
    }
  };

  // ====== APPROVE ======
  $("#btnApprove").onclick = async () => {
    try {
      if (!signer) throw new Error("Hubungkan wallet dulu.");
      await ensureSepolia();

      const sel = $("#tokenSel").value;
      const {addr, decimals} = TOKENS[sel];
      const amount = parseAmount($("#amount").value.trim(), decimals);

      const erc20 = new ethers.Contract(addr, [
        "function approve(address spender, uint256 value) external returns (bool)"
      ], signer);

      log(`üßæ Approve ${sel} ...`);
      const tx = await erc20.approve(WORMHOLE_BRIDGE, amount);
      log(`‚è≥ Approve TX: ${tx.hash}`);
      await tx.wait();
      log(`‚úÖ Approve ${sel} sukses!`);
    } catch (e) {
      log("‚ùå Approve error: " + (e.reason || e.message || e));
    }
  };

  // ====== BRIDGE ======
  $("#btnBridge").onclick = async () => {
    try {
      if (!signer) throw new Error("Hubungkan wallet dulu.");
      await ensureSepolia();

      const sel = $("#tokenSel").value;
      const {addr, decimals} = TOKENS[sel];
      const amountLD = parseAmount($("#amount").value.trim(), decimals);

      const recipient = ($("#recipient").value || me).trim();
      if (!/^0x[0-9a-fA-F]{40}$/.test(recipient)) throw new Error("Recipient address tidak valid.");
      const recipient32 = toBytes32Address(recipient);

      const bridge = new ethers.Contract(WORMHOLE_BRIDGE, [
        "function transferTokens(address token, uint256 amount, uint16 recipientChain, bytes32 recipient, uint256 arbiterFee, uint32 nonce) payable"
      ], signer);

      log(`üöÄ Mengirim ${$("#amount").value} ${sel} ke Monad...`);
      const nonce = Math.floor(Math.random()*2**32);
      const gasLimit = ethers.BigNumber.from("250000"); // konservatif

      const tx = await bridge.transferTokens(
        addr,
        amountLD,
        DST_CHAIN_ID,
        recipient32,
        0, // arbiterFee
        nonce,
        { gasLimit }
      );

      log(`üì¶ Bridge TX: ${tx.hash}`);
      const rc = await tx.wait();
      if (rc.status !== 1) throw new Error("Transaksi gagal (status != 1). Cek Etherscan log untuk detail.");

      log("‚úÖ Token berhasil dikirim ke Wormhole! Tunggu VAA & mint di Monad oleh relayer.");
      log("‚ÑπÔ∏è Jika perlu redeem manual, gunakan explorer Wormhole/relayer untuk mengambil VAA dan lakukan redeem di endpoint Monad.");
    } catch (e) {
      // error details
      const msg = (e.error && e.error.message) || e.reason || e.message || String(e);
      log("‚ùå Bridge error: " + msg);
      if (/UNPREDICTABLE_GAS_LIMIT/i.test(msg)) {
        log("üí° Hint: pastikan allowance sudah cukup, jumlah tidak terlalu kecil, dan bridge benar (Sepolia TokenBridge).");
      }
    }
  };
})();
</script>
</body>
</html>
